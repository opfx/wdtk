import { Tree } from '@angular-devkit/schematics';
import { SchematicTestRunner, UnitTestTree } from '@angular-devkit/schematics/testing';

import { readJsonInTree } from '@wdtk/core';
import { tags } from '@wdtk/core/util';
import { createEmptyWorkspace, getFileContent } from '@wdtk/core/testing';

import { Schema as InitOptions } from './schema';
import { UnitTestRunner } from './schema';

const schematicCollection = '@wdtk/nest';
const schematicName = 'library';

const defaultOpts: InitOptions = {
  name: 'test-lib',
};

describe('node init schematic', () => {
  const schematicRunner = new SchematicTestRunner(schematicCollection, require.resolve('../../collection.json'));

  const runSchematic = async (opts: InitOptions): Promise<UnitTestTree> => {
    return schematicRunner.runSchematicAsync(schematicName, opts, workspaceTree).toPromise();
  };
  let workspaceTree: Tree;

  beforeEach(async () => {
    workspaceTree = createEmptyWorkspace();
  });

  it(`should generate nest library files`, async () => {
    const tree = await runSchematic(defaultOpts);
    expect(tree.exists(`/${defaultOpts.name}/package.json`)).toBeTruthy();
    expect(tree.exists(`/${defaultOpts.name}/tsconfig.lib.json`)).toBeTruthy();
    expect(tree.exists(`/${defaultOpts.name}/tsconfig.json`)).toBeTruthy();
    expect(tree.exists(`/${defaultOpts.name}/tslint.json`)).toBeTruthy();
    expect(tree.exists(`/${defaultOpts.name}/src/index.ts`)).toBeTruthy();
  });

  it(`should remove the default source files generated by @wdtk/node:lib`, async () => {
    const tree = await runSchematic(defaultOpts);
    expect(tree.exists(`/${defaultOpts.name}/src/lib/${defaultOpts.name}.ts`)).toBeFalsy();
  });

  it(`should generate valid module code`, async () => {
    const tree = await runSchematic(defaultOpts);
    const sourceCode = getFileContent(tree, `/${defaultOpts.name}/src/lib/${defaultOpts.name}.module.ts`);
    expect(tags.stripIndents`${sourceCode}`).toEqual(tags.stripIndents`
    import { Module } from '@nestjs/common';
    import { TestLibService } from './${defaultOpts.name}.service';
    import { TestLibController } from './${defaultOpts.name}.controller'; 
    
    @Module({
    controllers: [ TestLibController ],
    providers: [ TestLibService ], 
    exports: [ TestLibService ],
    })
    export class TestLibModule {}
    `);
  });

  it(`should generate valid controller code`, async () => {
    const tree = await runSchematic(defaultOpts);
    const sourceCode = getFileContent(tree, `/${defaultOpts.name}/src/lib/${defaultOpts.name}.controller.ts`);
    expect(tags.stripIndents`${sourceCode}`).toEqual(tags.stripIndents`
    import { Controller } from '@nestjs/common';
    import { TestLibService } from './test-lib.service';
          
    @Controller('test-lib')
    export class TestLibController {
      constructor(private testLibService: TestLibService) {}
    }
    `);
  });

  it(`should correctly populate the barrel file`, async () => {
    const tree = await runSchematic(defaultOpts);
    const barrel = getFileContent(tree, `/${defaultOpts.name}/src/index.ts`);
    expect(tags.stripIndents`${barrel}`).toEqual(tags.stripIndents`
          export * from './lib/${defaultOpts.name}.module';
          export * from './lib/${defaultOpts.name}.service';
          export * from './lib/${defaultOpts.name}.controller';
    `);
  });

  it(`should update the root tsconfig with the nest library entry file`, async () => {
    const tree = await runSchematic(defaultOpts);
    const tsconfig = readJsonInTree(tree, 'tsconfig.json');
    expect(tsconfig.compilerOptions.paths['@empty/test-lib']).toEqual([`/${defaultOpts.name}/src/index.ts`]);
  });

  describe(`--directory`, () => {
    it('should generate nest library files in the specified directory', async () => {
      const tree = await runSchematic({ ...defaultOpts, directory: `libs/${defaultOpts.name}` });
      expect(tree.exists(`libs/${defaultOpts.name}/package.json`)).toBeTruthy();
      expect(tree.exists(`/libs/${defaultOpts.name}/tsconfig.lib.json`)).toBeTruthy();
      expect(tree.exists(`/libs/${defaultOpts.name}/tsconfig.json`)).toBeTruthy();
      expect(tree.exists(`/libs/${defaultOpts.name}/src/index.ts`)).toBeTruthy();
    });
  });

  describe(`--unitTestRunner`, () => {
    it('should configure jest if unitTestRunner is jest', async () => {
      const tree = await runSchematic({ ...defaultOpts, unitTestRunner: UnitTestRunner.Jest });
      expect(tree.exists('jest.config.js')).toBeTruthy();
    });

    it('should generate jest test files if unitTestRunner is jest', async () => {
      const tree = await runSchematic({ ...defaultOpts, unitTestRunner: UnitTestRunner.Jest });
      expect(tree.exists(`/${defaultOpts.name}/src/lib/${defaultOpts.name}.controller.spec.ts`)).toBeTruthy();
      expect(tree.exists(`/${defaultOpts.name}/src/lib/${defaultOpts.name}.service.spec.ts`)).toBeTruthy();
    });

    it('should not configure jest if unitTestRunner is none', async () => {
      const tree = await runSchematic({ ...defaultOpts, unitTestRunner: UnitTestRunner.None });
      expect(tree.exists('jest.config.js')).toBeFalsy();
    });

    it('should not generate jest test files if unitTestRunner is jest', async () => {
      const tree = await runSchematic({ ...defaultOpts, unitTestRunner: UnitTestRunner.None });
      expect(tree.exists(`/${defaultOpts.name}/src/lib/${defaultOpts.name}.controller.spec.ts`)).toBeFalsy();
      expect(tree.exists(`/${defaultOpts.name}/src/lib/${defaultOpts.name}.service.spec.ts`)).toBeFalsy();
    });
  });
});
